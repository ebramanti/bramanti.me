<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>
    Edward Bramanti
    
      | Are you serial, Promise.all?
    
  </title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Are you serial, Promise.all?">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://bramanti.me/are-you-serial-promise-all/">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="Edward Bramanti">
  <meta property="og:image" content="">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://bramanti.me/are-you-serial-promise-all/">
  <meta name="twitter:title" content="Are you serial, Promise.all?">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="">

  <link href="https://bramanti.me/feed.xml" type="application/rss+xml" rel="alternate" title="Edward Bramanti Last 10 blog posts" />

  

  
    <link rel="stylesheet" href="/assets/dark.css">

  
</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav appear">
  <a href="/" class="header-logo" title="Edward Bramanti">Edward Bramanti</a>
  <ul class="header-links">
    
      <li>
        <a href="/about">
          About
        </a>
      </li>
    
    
      <li>
        <a href="https://represent.io/ebramanti" rel="noreferrer noopener" target="_blank">
          Resume
        </a>
      </li>
    
    
      <li>
        <a href="https://github.com/jadengore" rel="noreferrer noopener" target="_blank">
          Github
        </a>
      </li>
    
    
      <li>
        <a href="https://www.linkedin.com/in/edwardbramanti" rel="noreferrer noopener" target="_blank">
          LinkedIn
        </a>
      </li>
    
    
      <li>
        <a href="mailto:edward@bramanti.org">
          Email
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <span class="icon icon-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article appear">
          <header class="article-header">
            <h1>Are you serial, Promise.all?</h1>
            <p></p>
            <div class="article-list-footer">
              <span class="article-list-date">
                March 4, 2016
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  4 minute read
                
              </span>
              
                <span class="article-list-divider">-</span>
                <div class="article-list-tags">
                  
                    <a href="/tag/javascript">javascript</a>
                  
                </div>
              
            </div>
          </header>

          <div class="article-content">
            <p>About a month ago, I came across an interesting problem at work where a database migration with <a href="knexjs.org">Knex</a> was not working properly. An example similar to the actual problem is shown below:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">up</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">knex</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">renameTable</span><span class="p">(</span><span class="s1">'tomatoes'</span><span class="p">,</span> <span class="s1">'potatoes'</span><span class="p">),</span>
    <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">'potatoes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">))</span>
  <span class="p">]);</span>
<span class="p">};</span></code></pre></figure>

<p>The first promise renames a table from <code class="highlighter-rouge">tomatoes</code> to <code class="highlighter-rouge">potatoes</code>. The following promise adds the string column <code class="highlighter-rouge">name</code> to the newly renamed table <code class="highlighter-rouge">potatoes</code>. While there may seem to be nothing wrong here, this code resulted in an error, saying the table <code class="highlighter-rouge">potatoes</code> did not exist.</p>

<p>It turns out the problem was the Promise collection itself. I had a preconceived notion that the API for <a href="http://bluebirdjs.com/docs/api/promise.all.html"><code class="highlighter-rouge">Promise.all</code></a> was a function that resolved a promise array sequentially. It turns out it <a href="https://github.com/petkaantonov/bluebird/issues/134#issuecomment-37192469">resolves asynchronous tasks concurrently</a>!</p>

<p><a href="https://github.com/petkaantonov/bluebird/issues/134">There was an issue open at one point for a sequential Promise collection method</a>, and the author of Bluebird does give a <a href="https://github.com/petkaantonov/bluebird/issues/134#issuecomment-36976462">compelling argument</a> for why <code class="highlighter-rouge">Promise.series</code> was never added to Bluebird. Nevertheless, I wanted to solve my current issue without using callbacks. I needed a way to serially resolve an array of promises and return an array of results.</p>

<p>My solution was to extend Bluebird with a <code class="highlighter-rouge">Promise.series</code> method that will take in an Iterable and return a Promise that resolves similarly to <code class="highlighter-rouge">Promise.all</code>, but with all of the promises executed serially through using <a href="http://bluebirdjs.com/docs/api/promise.reduce.html"><code class="highlighter-rouge">Promise.reduce</code></a>.</p>

<p>Here’s the code I wrote for <code class="highlighter-rouge">Promise.series</code>:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">series</span> <span class="o">=</span> <span class="p">(</span><span class="nx">promiseArr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">promiseArr</span><span class="p">,</span> <span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">promise</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="p">[]);</span>
<span class="p">};</span></code></pre></figure>

<p>The above implementation of series uses <code class="highlighter-rouge">Promise.reduce</code> to return a promise that will iterate through the promise array, and resolve each promise one after the other. This function will return an array of resolved values (the starting value is the empty array, and results are pushed in as the reducer executes).</p>

<p><strong>There is a caveat</strong>: for this method to work, we must wrap each promise in a function, almost like a factory. Promises must be wrapped because as soon as a promise is created, it begins execution (see <code class="highlighter-rouge">new Promise()</code> documentation <a href="http://bluebirdjs.com/docs/api/new-promise.html">here</a>).</p>

<p>Simple example below (thanks to <a href="https://news.ycombinator.com/user?id=madeofpalk">madeofpalk</a> on Hacker News):</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">func1</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'func1 start'</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'func1 complete'</span><span class="p">);</span>
        <span class="nx">resolve</span><span class="p">();</span>
    <span class="p">},</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">func2</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'func2 start'</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'func2 complete'</span><span class="p">);</span>
        <span class="nx">resolve</span><span class="p">();</span>
    <span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">});</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">series</span><span class="p">([</span><span class="nx">func1</span><span class="p">,</span> <span class="nx">func2</span><span class="p">]);</span>
<span class="c1">// Resolves to:</span>
<span class="c1">// func1 start</span>
<span class="c1">// func1 complete</span>
<span class="c1">// func2 start</span>
<span class="c1">// func2 complete</span></code></pre></figure>

<p>This gives us the serial execution we desire, and it allows our example above to work!</p>

<p>So, let’s update the initial example with the new series method we have:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nb">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bluebird'</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">up</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">knex</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">series</span><span class="p">([</span>
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">renameTable</span><span class="p">(</span><span class="s1">'tomatoes'</span><span class="p">,</span> <span class="s1">'potatoes'</span><span class="p">),</span>
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">'potatoes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">))</span>
  <span class="p">]);</span>
<span class="p">};</span></code></pre></figure>

<p>Presto! The first promise now resolves before the second promise transitions to pending, which means that the <code class="highlighter-rouge">potatoes</code> table now exists and we can add columns to it. By extending Bluebird, we now have a function for those rare cases when the performance benefits of parallel execution are derailed by a need for serial execution.</p>

<p>A serial solution for serial people.</p>

<p><a href="https://news.ycombinator.com/item?id=11227069">Discuss on Hacker News!</a></p>

<p><em>Edit: I’ve updated the post with a better example to more clearly demonstrate the problem I was trying to solve.</em></p>

<p><em>Edit 2: As a bunch of people on Hacker News have pointed out, <a href="https://gist.github.com/jadengore/daa0fcf243325ab458a7">my initial implementation of <code class="highlighter-rouge">Promise.series</code></a> does not work because the promises are already executing if passed directly into <code class="highlighter-rouge">Promise.series</code> without being wrapped in a function that returns a new Promise (essentially, a factory). I have therefore gone ahead and performed a major rewrite of the implementation of <code class="highlighter-rouge">Promise.series</code> and the examples, with a new section explaining this. Special thanks to <a href="https://news.ycombinator.com/user?id=flattersatz">flattersatz</a> and <a href="https://news.ycombinator.com/user?id=madeofpalk">madeofpalk</a>’s comments, and to a <a href="http://www.datchley.name/promise-patterns-anti-patterns/">great article by David Atchley</a> that helped me along the way to a better solution.</em></p>

          </div>

          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Are+you+serial%2C+Promise.all%3F - https://bramanti.me/are-you-serial-promise-all/" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://bramanti.me/are-you-serial-promise-all/" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
            <a href="https://plus.google.com/share?url=https://bramanti.me/are-you-serial-promise-all/" title="Share on Google+" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 128 128"><path d="M40.7 55.9v16.1c0 0 15.6 0 22 0C59.2 82.5 53.8 88.2 40.7 88.2c-13.3 0-23.7-10.8-23.7-24.2s10.4-24.2 23.7-24.2c7.1 0 11.6 2.5 15.8 5.9 3.3-3.3 3.1-3.8 11.6-11.9 -7.2-6.6-16.8-10.6-27.4-10.6C18.2 23.3 0 41.5 0 64c0 22.5 18.2 40.7 40.7 40.7 33.6 0 41.8-29.3 39-48.8H40.7zM113.9 56.7V42.6h-10.1v14.1H89.4v10.1h14.5v14.5h10.1V66.8H128V56.7H113.9z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://bramanti.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer appear">
  <p>
    Chalk is a high quality, completely customizable, performant and 100% free
    blog template for Jekyll built by Nielsen Ramon.
    Download it <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Download Chalk">here</a>.
  </p>
  
</footer>

      </div>
    </div>
  </main>
  


<script type="text/javascript">
  window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
  heap.load("7009234");
</script>


<script src="/assets/vendor.js"></script>



  <script src="/assets/webfonts.js"></script>




  <script src="/assets/scrollappear.js"></script>



<script src="/assets/application.js"></script>


</body>
</html>
